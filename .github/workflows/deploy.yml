name: Deploy to Railway

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Setup Railway Project
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          # Create Railway config directory and file
          mkdir -p .railway
          echo '{}' > .railway/config.json
          
          # Try to link or find the project
          echo "Attempting to set environment variable..."
          
      - name: Deploy and Set Environment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: a18c5404-6b6a-4d09-936f-e90d391a5a2d
        run: |
          # Link to the specific project first
          railway link --project $RAILWAY_PROJECT_ID
          
          # Deploy to the linked project
          railway up --project $RAILWAY_PROJECT_ID
          
          # Try setting variable after deployment
          railway variables set CURSEFORGE_API_KEY="${{ secrets.CURSEFORGE_API_KEY }}" --project $RAILWAY_PROJECT_ID || echo "Could not set variable automatically"
          
          echo ""
          echo "=========================================="
          echo "Deployment complete"
          echo "Project ID: $RAILWAY_PROJECT_ID"
          echo "=========================================="
